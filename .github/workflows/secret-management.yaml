name: Secret Management

on:
  workflow_dispatch:
    inputs:
      operation:
        description: 'Operation to perform'
        required: true
        default: 'validate'
        type: choice
        options:
        - validate
        - decrypt-preview

jobs:
  manage-secrets:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install SOPS
      run: |
        curl -LO https://github.com/getsops/sops/releases/download/v3.11.0/sops-v3.11.0.linux.amd64
        sudo mv sops-v3.11.0.linux.amd64 /usr/local/bin/sops
        sudo chmod +x /usr/local/bin/sops
        sops --version
        
    - name: Setup Age key
      run: |
        mkdir -p ~/.config/sops/age
        echo "${{ secrets.SOPS_AGE_KEY }}" > ~/.config/sops/age/keys.txt
        chmod 600 ~/.config/sops/age/keys.txt
        
    - name: Validate Secrets
      if: inputs.operation == 'validate'
      run: |
        echo "Validating all encrypted secrets..."
        for file in secrets/*.enc.yaml; do
          echo "Validating $file"
          sops --decrypt "$file" > /dev/null && echo "âœ“ $file is valid"
        done
        
    - name: Decrypt Preview
      if: inputs.operation == 'decrypt-preview'
      run: |
        echo "Preview of all secrets:"
        for file in secrets/*.enc.yaml; do
          echo "=== $file ==="
          sops --decrypt "$file"
          echo
        done
