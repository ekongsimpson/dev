name: Deploy Encrypted Secrets to Flux

on:
  push:
    branches: [ main ]
    paths: 
      - 'secrets/**'
      - '.github/workflows/deploy-secrets.yaml'
  workflow_dispatch:

jobs:
  deploy-secrets:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install SOPS
      run: |
        curl -LO https://github.com/getsops/sops/releases/download/v3.11.0/sops-v3.11.0.linux.amd64
        sudo mv sops-v3.11.0.linux.amd64 /usr/local/bin/sops
        sudo chmod +x /usr/local/bin/sops
        sops --version
        
    - name: Setup Age key
      run: |
        mkdir -p ~/.config/sops/age
        echo "${{ secrets.SOPS_AGE_KEY }}" > ~/.config/sops/age/keys.txt
        chmod 600 ~/.config/sops/age/keys.txt
        
    - name: Validate encrypted secrets
      run: |
        echo "Validating encrypted secrets..."
        for file in secrets/*.enc.yaml; do
          echo "Validating $file"
          sops --decrypt "$file" > /dev/null && echo "âœ“ $file is valid"
        done
        
    - name: Commit decrypted secrets (for Flux)
      if: github.ref == 'refs/heads/main'
      run: |
        # Decrypt secrets to a temporary directory for validation
        mkdir -p decrypted-secrets
        for file in secrets/*.enc.yaml; do
          base_name=$(basename "$file" .enc.yaml)
          sops --decrypt "$file" > "decrypted-secrets/${base_name}.yaml"
        done
        
        echo "Secrets decrypted for Flux sync"
        ls -la decrypted-secrets/
